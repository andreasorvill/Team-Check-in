<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SANA – Word Cloud Dashboard</title>

  <link rel="stylesheet" href="styles.css">

  <!-- WordCloud2.js -->
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.3/src/wordcloud2.min.js"></script>

  <style>
    /* Ensures the cloud box always has a real height */
    #cloud {
      width: 100%;
      height: 72vh;
      background: #1f1f1f;
      border-radius: 12px;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
    }
  </style>
</head>

<body class="dashboard-body">

  <div class="dashboard-container">
    
    <img src="images/SANA_simple.png" class="dashboard-logo" alt="SANA Logo">
    
    <h1 class="dashboard-title">Weekly Word Cloud</h1>
    <p class="dashboard-subtitle">The most frequently selected words appear largest.</p>

    <div id="cloud" class="cloud-box"></div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
      <button class="back-btn" onclick="window.location.href='index.html'">← Back to Check-In</button>
      <button class="back-btn" id="reloadBtn" style="background:#003d72;color:#fff;">Reload</button>
    </div>

  </div>


  <script>
    // RAW Apps Script endpoint
    const RAW_API =
      "https://script.google.com/macros/s/AKfycbwWDyuw9r1IQCWZzGBC2up3pN53X3BpjQRnCDRbZpXsmQ70UYTTjUQQUUXeR80YkqFXTg/exec";

    // Cloudflare Worker proxy for CORS
    const PROXY = "https://sana-cors-proxy.andreas-orvill.workers.dev/?url=";

    // Always fetch fresh data (prevents browser/GitHub cache)
    function buildURL() {
      return PROXY + encodeURIComponent(RAW_API) + "&t=" + Date.now();
    }


    async function loadDataAndRender() {
      const DATA_URL = buildURL();
      console.log("Fetching:", DATA_URL);

      try {
        const res = await fetch(DATA_URL);
        const entries = await res.json();

        console.log("Entries:", entries.length);
        console.log("Sample:", entries.slice(0, 8));

        // Count frequencies
        const freq = {};
        entries.forEach(entry => {
          if (!entry?.words) return;
          entry.words.forEach(w => {
            const clean = w?.trim();
            if (!clean) return;
            freq[clean] = (freq[clean] || 0) + 1;
          });
        });

        console.log("Frequency map:", freq);

        const words = Object.keys(freq);
        if (!words.length) {
          document.getElementById("cloud").innerHTML =
            "<div style='color:#ccc;padding:18px'>No submitted words yet.</div>";
          return;
        }

        // Determine min/max values
        const counts = Object.values(freq);
        const minCount = Math.min(...counts);
        const maxCount = Math.max(...counts);

        function sizeForCount(count) {
          const minSize = 16;
          const maxSize = 70;
          if (maxCount === minCount) return (minSize + maxSize) / 2;
          const t = (count - minCount) / (maxCount - minCount);
          return Math.round(minSize + Math.pow(t, 0.85) * (maxSize - minSize));
        }

        function colorForCount(count) {
          // high frequency = warmer color
          const minHue = 220; // blue
          const maxHue = 45;  // orange/red
          if (maxCount === minCount) return `hsl(${(minHue + maxHue) / 2},70%,55%)`;
          const t = (count - minCount) / (maxCount - minCount);
          const hue = Math.round(minHue + (maxHue - minHue) * t);
          return `hsl(${hue},75%,60%)`;
        }

        // Prepare list
        const list = words.map(w => [w, sizeForCount(freq[w])])
                          .sort((a, b) => b[1] - a[1]);

        const cloudEl = document.getElementById("cloud");
        cloudEl.innerHTML = "";

        // Reliable size detection
        const rect = cloudEl.getBoundingClientRect();
        let w = Math.floor(rect.width);
        let h = Math.floor(rect.height);

        if (w < 50) w = 600;
        if (h < 50) h = 400;

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        cloudEl.appendChild(canvas);

        WordCloud(canvas, {
          list: list,
          gridSize: Math.round(14 * (canvas.width / 800)),
          weightFactor: (word, weight) => weight,
          fontFamily: "Arial, sans-serif",
          color: word => colorForCount(freq[word]),
          rotateRatio: 0.08,
          rotationSteps: 2,
          backgroundColor: "transparent"
        });

      } catch (err) {
        console.error("Error loading cloud:", err);
        document.getElementById("cloud").innerHTML =
          "<div style='color:#ffaaaa;padding:15px'>Error loading cloud.</div>";
      }
    }


    // Initial load
    loadDataAndRender();

    // Allow manual reload
    document.getElementById("reloadBtn").addEventListener("click", loadDataAndRender);

  </script>

</body>
</html>
