<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SANA – Word Cloud Dashboard</title>

  <link rel="stylesheet" href="styles.css">

  <!-- D3 + D3-Cloud -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud/build/d3.layout.cloud.min.js"></script>

  <style>
    #cloud {
      width: 100%;
      height: 72vh;
      background: #1f1f1f;
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body class="dashboard-body">

  <div class="dashboard-container">
    
    <img src="images/SANA_simple.png" class="dashboard-logo" alt="SANA Logo">
    
    <h1 class="dashboard-title">Weekly Word Cloud</h1>
    <p class="dashboard-subtitle">The most frequently selected words appear largest.</p>

    <div id="cloud"></div>

    <div style="display:flex;gap:10px;justify-content:center;margin-top:18px;">
      <button class="back-btn" onclick="window.location.href='index.html'">← Back to Check-In</button>
      <button class="back-btn" id="reloadBtn" style="background:#003d72;color:#fff;">Reload</button>
    </div>
  </div>

  <script>
    const RAW_API =
      "https://script.google.com/macros/s/AKfycbwWDyuw9r1IQCWZzGBC2up3pN53X3BpjQRnCDRbZpXsmQ70UYTTjUQQUUXeR80YkqFXTg/exec";

    const PROXY = "https://sana-cors-proxy.andreas-orvill.workers.dev/?url=";

    function buildURL() {
      return PROXY + encodeURIComponent(RAW_API) + "&t=" + Date.now();
    }

    async function loadDataAndRender() {
      const DATA_URL = buildURL();
      console.log("Fetching:", DATA_URL);

      try {
        const res = await fetch(DATA_URL);
        const entries = await res.json();

        console.log("Entries:", entries.length);

        // Build frequency map
        const freq = {};
        entries.forEach(entry => {
          entry.words.forEach(w => {
            if (!w) return;
            const clean = w.trim();
            freq[clean] = (freq[clean] || 0) + 1;
          });
        });

        console.log("Frequency map:", freq);

        const cloudWords = Object.keys(freq).map(word => ({
          text: word,
          size: freq[word],
        }));

        if (!cloudWords.length) {
          document.getElementById("cloud").innerHTML =
            "<div style='color:#ccc;padding:18px'>No submitted words yet.</div>";
          return;
        }

        // D3 cloud dimensions
        const cloudBox = document.getElementById("cloud");
        const width = cloudBox.clientWidth;
        const height = cloudBox.clientHeight;

        // Center-heavy scaling
        const maxFreq = d3.max(cloudWords, d => d.size);
        const fontSize = d3.scaleSqrt()
          .domain([1, maxFreq])
          .range([15, 90]); // min/max font size

        // Remove previous SVG
        cloudBox.innerHTML = "";

        // Create cloud layout
        const layout = d3.layout.cloud()
          .size([width, height])
          .words(cloudWords)
          .padding(8)
          .font("Arial")
          .fontSize(d => fontSize(d.size))
          .spiral("archimedean")  // nice smooth expansion from center
          .rotate(0)              // horizontal only
          .on("end", draw);

        layout.start();

        function draw(words) {
          const svg = d3.select("#cloud")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2},${height / 2})`);

          // color scale from cool → warm
          const color = d3.scaleLinear()
            .domain([1, maxFreq])
            .range(["#7fa9ff", "#ffb347"]);

          svg.selectAll("text")
            .data(words)
            .enter().append("text")
            .style("font-family", "Arial")
            .style("font-size", d => d.size + "px")
            .style("fill", d => color(freq[d.text]))
            .attr("text-anchor", "middle")
            .attr("transform", d => `translate(${d.x},${d.y})`)
            .text(d => d.text);
        }

      } catch (err) {
        console.error("Error loading cloud:", err);
      }
    }

    loadDataAndRender();

    document.getElementById("reloadBtn").addEventListener("click", loadDataAndRender);
  </script>

</body>
</html>
